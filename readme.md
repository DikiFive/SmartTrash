# 智能垃圾桶控制系统

基于STM32F103C8T6的智能垃圾桶控制系统，实现自动开关盖、垃圾满溢检测、烟雾报警和实时时钟显示等功能。

## 功能特点

1. **自动开关盖**
   - 超声波测距检测人体靠近（距离 < 25cm）
   - 连续3次检测到才开盖，防误触
   - 人离开后3秒延时关闭
   - 支持语音控制开关

2. **垃圾状态检测**
   - 双红外传感器检测（顶部+底部）
   - 三种状态指示：
     * 空：两个传感器都未被遮挡，绿灯亮
     * 有垃圾：底部被遮挡顶部未遮挡，黄灯亮
     * 已满：两个传感器都被遮挡，红灯亮+蜂鸣器报警

3. **清理超时提醒**
   - 垃圾未及时清理（3分钟）自动报警
   - 红灯亮+蜂鸣器报警
   - OLED实时显示未清理时长

4. **烟雾检测报警**
   - MQ2烟雾传感器实时监测
   - 当浓度超过300PPM时自动报警
   - OLED显示烟雾PPM浓度值

5. **实时时钟显示**
   - 采用DS1302实时时钟芯片
   - 带备用电池，断电仍可保持计时
   - OLED显示当前日期和时间

6. **状态显示**
   - OLED显示（128x64像素，4行显示）：
     * 第1行：垃圾桶状态 + 距离值
     * 第2行：未清理时间（MM:SS）
     * 第3行：当前日期（YYYY/MM/DD）
     * 第4行：当前时间（HH:MM:SS）+ PPM值

## 硬件连接

### 传感器
- **超声波（HC-SR04）**
  - Trig: PB6
  - Echo: PB7

- **红外对射传感器**
  - 底部传感器: PA0
  - 顶部传感器: PA1

- **烟雾传感器（MQ2）**
  - ADC输入: PA4

- **实时时钟（DS1302）**
  - CE: PA5
  - SCLK: PA7
  - DATA: PA6

### 执行器
- **舵机**
  - 控制信号: PB0（TIM3 CH3）

- **LED指示灯**
  - 绿灯（空）: PC13
  - 黄灯（有垃圾）: PC14
  - 红灯（满/报警）: PC15

- **蜂鸣器**
  - 控制信号: PB12

### 显示通信
- **OLED显示屏（SSD1306）**
  - SCL: PB8
  - SDA: PB9

- **串口1（语音模块）**
  - TX: PA9
  - RX: PA10

## 软件架构

### 核心文件
- **main.c**: 主程序入口，任务调度
- **DK_C8T6.c/h**: 核心功能实现
   * 传感器数据处理
   * 状态管理
   * 报警逻辑
- **ds1302.c/h**: 实时时钟驱动

### 模块化设计
1. **初始化模块**
   - `Sys_Init()`: 外设初始化
   - `InitTrashSystem()`: 系统状态初始化
   - `DS1302_Init()`: 时钟初始化

2. **传感器处理模块**
   - `HandleUltrasonicSensor()`: 超声波控制
   - `ProcessSensorData()`: 红外传感器处理
   - `CheckSmoke()`: 烟雾检测
   - `DS1302_read_realTime()`: 读取实时时间

3. **状态管理模块**
   - `CheckCleanupTimeout()`: 清理超时检查
   - `UpdateStatusIndicators()`: LED和蜂鸣器控制
   - `UpdateOLEDDisplay()`: 显示更新

4. **通信控制模块**
   - `ProcessSerialCommands()`: 串口命令处理

## 编译说明

### 开发环境
- Keil MDK 5.xx
- ARM Compiler v5.06
- STM32F10x Standard Peripheral Library

### 编译步骤
1. 用Keil打开项目文件 `Trash.uvprojx`
2. 选择 STM32F103C8 目标器件
3. 编译工程

## 使用说明

### 操作指令
语音模块串口指令：
- 0x11: 打开垃圾桶盖
- 0x22: 关闭垃圾桶盖

### 状态指示
LED指示：
- 绿灯：垃圾桶空
- 黄灯：有垃圾
- 红灯：垃圾满/烟雾报警/清理超时

### 注意事项
1. 首次使用需要通过DS1302_SetTime函数设置正确的时间
2. DS1302带备用电池，设置一次后即可保持运行
3. 超声波触发距离为25cm，需连续3次检测才会开盖
4. 清理计时器在垃圾桶被清空时自动重置
5. 报警优先级：烟雾报警 > 清理超时报警 > 垃圾满报警

## 维护与调试

### 参数调整
主要可调参数位于 `DK_C8T6.c`：
```c
#define SMOKE_THRESHOLD_PPM 300  // 烟雾报警阈值(PPM)
#define CLEANUP_TIMEOUT_S   180  // 清理超时时间(秒)
#define WINDOW_SIZE         5    // 距离平均滤波窗口
#define TRIGGER_THRESHOLD   3    // 开盖触发阈值
#define CLOSE_DELAY_MS     3000 // 关盖延时(毫秒)
```

### 时间设置
使用 `DS1302_SetTime` 函数设置时间：
```c
// 设置时间示例 (2025年5月6日20:30:00 星期二)
DS1302_SetTime(2025, 5, 6, 20, 30, 0, 2);
```

### 调试接口
1. 串口1（PA9/PA10）：语音控制
2. 串口3：预留调试接口

## 版本历史

### v1.1.0 (2025-05-06)
- 添加DS1302实时时钟显示
- 优化OLED显示布局
- 修复红外传感器状态判断逻辑

### v1.0.0 (2025-05-06)
- 初始版本
- 实现基本功能
- 完成代码模块化重构
